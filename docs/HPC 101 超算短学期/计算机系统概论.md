# Introduction of Computer System in HPC

## Chapter 1 Operating System

### Introduction

- **CPU: æŠ½è±¡æ¨¡å‹**

  <img src="C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20250627141544701.png" alt="image-20250627141544701" style="zoom:50%;" />

!!! Note "ä¸æ˜¯æ‰€æœ‰CPUæŒ‡ä»¤æ‰€ç”¨æ—¶é—´éƒ½ç›¸åŒ"

- **Memoryå±‚çº§**

  <img src="C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20250627142210998.png" alt="image-20250627142210998" style="zoom:50%;" />

:star2:==Operating System is **resource abstractor and resource allocator**==

### OS Events

**Traps in RISC-V:**

- Interrupts : external asynchronous events
  - Hardware-Generated
  - some device controller says "something happened"
- Exception: Unusual condition occurring at instruction run time
  - Software-Generated
  - e.g. a division by zero

**When a trap occurs, the control flow is switched to its handler:**

<img src="C:\Users\Lenovo\Pictures\Screenshots\å±å¹•æˆªå›¾ 2025-06-27 143847.png" alt="å±å¹•æˆªå›¾ 2025-06-27 143847" style="zoom:75%;" />

**æ­¤æ­¥éª¤æœ‰æ“ä½œç³»ç»Ÿå®Œæˆ**

ğŸ¤” **Q: What do we need to separate the user and kernel space?**

ğŸ˜ A: Add a **Mode Bit(ä¸€ä¸ªç”µè·¯)** to keep track of the current **privilege level(ç‰¹æƒç­‰çº§)**

**System calls**: a special kind of trap

> When a user program needs to do something to do something privileged, it **calls a system call**.
>
> <img src="C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20250627145254874.png" alt="image-20250627145254874" style="zoom: 67%;" />
>
> æ¯”å¦‚write: æŠŠç»“æœæ‰“å°åœ¨å‘½ä»¤è¡Œ
>
> main->printf(GNU C Library)->write
>
> **straceå‘½ä»¤:**è¿½è¸ªsystem callçš„è¿‡ç¨‹

**Timers**: é˜²æ­¢ç¨‹åºå¡æ­»ï¼Œä¿è¯å¤šä¸ªè¿›ç¨‹è½®æµæ‰§è¡Œ

### Process è¿›ç¨‹

:star2:==A process is a **program in execution, a unit of resource allocation and collection**.==

> `file hello`:æŸ¥çœ‹helloæ–‡ä»¶çš„å±æ€§

**ELFæ ¼å¼: Executable and Linkable Format**

<img src="C:\Users\Lenovo\Pictures\Screenshots\å±å¹•æˆªå›¾ 2025-06-27 151506.png" alt="å±å¹•æˆªå›¾ 2025-06-27 151506" style="zoom:80%;" />

**Process Address Space:**

<img src="C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20250627152034367.png" alt="image-20250627152034367" style="zoom:80%;" />

**Stack Frame**

æ‰§è¡ŒSystem callæ—¶ï¼Œ**è°ƒç”¨å†…æ ¸æ€æ—¶ä¸ä¼šä¿å­˜åˆ°ç”¨æˆ·æ ˆçš„æ ˆå¸§**

e.g. printfè°ƒç”¨writeæ—¶ï¼Œwrite ä¸ä¼šä¿å­˜åˆ°ç”¨æˆ·æ ˆçš„æ ˆå¸§ä¸­

sp fp:å®šä½å‡½æ•°åœ¨æ ˆä¸­çš„æ ˆå¸§èŒƒå›´,ä¹Ÿå¯ä»¥æŸ¥çœ‹å‡½æ•°çš„è°ƒç”¨é“¾å…³ç³»

#### Process Schedule è¿›ç¨‹è°ƒåº¦

- **Non-preemptive**: The process must finish its execution before the OS can schedule another process.(éæŠ¢å å¼ï¼Œåˆ«çš„è¿›ç¨‹ä¸èƒ½æŠ¢å CPU)

- **preemptive**: The OS can interrupt a process to schedule another one.(æŠ¢å å¼)

  **Schedule Algorithm:**

  - Round Robinï¼šæ—¶é—´ç‰‡è½®è½¬ï¼Œè½®æµè·‘
  - Priority-based:åŸºäºä¼˜å…ˆçº§ï¼Œ**é€šè¿‡`nice`æŒ‡ä»¤å¯è°ƒé«˜ä¼˜å…ˆçº§** 

  

:star2:==**Also decide which process to run on which core.**(Controlled by **Core Affinity**)== ç»‘æ ¸ç»‘çš„æ˜¯CPUå’Œçº¿ç¨‹

#### Process Switch è¿›ç¨‹åˆ‡æ¢

åˆ‡æ¢Contextçš„çŠ¶æ€ï¼šè¿›ç¨‹å‡ºæ¥æ—¶ä¿å­˜ä¸Šä¸‹æ–‡ï¼Œå›å»æ—¶æ¢å¤ä¸Šä¸‹æ–‡

**PCB:**è¿›ç¨‹æ§åˆ¶å—ï¼Œä¸€ç§ç»“æ„ï¼Œä¿å­˜äº†PIDä»¥åŠcontextçš„çŠ¶æ€

### Inter-Process Communication (IPC) è·¨è¿›ç¨‹ä¼ è¾“

å°†å¯ä»¥åŒæ—¶è¿›è¡Œçš„è¿›ç¨‹æ”¾åˆ°å¤šä¸ªCPUæ ¸å¿ƒä¸Šå¹¶è¡Œï¼Œä½†æ˜¯æ“ä½œç³»ç»Ÿä¸ä¼šè®©ä¸€ä¸ªè¿›ç¨‹è®¿é—®å¦ä¸€ä¸ªè¿›ç¨‹çš„å†…å­˜ï¼Œå› æ­¤å„ä¸ªè¿›ç¨‹çš„æ•°æ®æ— æ³•ç´¯åŠ 

å¦‚ä½•å®ç°ï¼š

- **Message Passing**: è®©ä¸€ä¸ªè¿›ç¨‹å‘ä¸»è¿›ç¨‹å‘é€æ•°æ®ç”¨**MPI**æ”¶å‘æ•°æ®ï¼Œé€šè¿‡ä¸€ä¸ª**message queue**è¿›è¡Œä¼ è¾“
- **Shared Memory:**æ“ä½œç³»ç»Ÿæä¾›ä¸€å—å†…å­˜ï¼Œä½¿å¾—ä¸¤ä¸ªè¿›ç¨‹å¯ä»¥åŒæ—¶è®¿é—®è¿™åŒä¸€å—å†…å­˜
- **Signal,Pipe,Socket,...**

**Disadvantage of IPC:**

![image-20250627162006529](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20250627162006529.png)

### Thread çº¿ç¨‹

:star2: A thread is a **basic unit of execution **within a process. Each thread has its own:

- Thread ID
- Program counter
- Register set
- Stack

Shares the following with other threads within the same process:

* Code section

- Data section

- The heap (dynamically allocated memory)

- Open files and signals

çº¿ç¨‹ä¹‹é—´çš„åœ°å€ç©ºé—´ã€å†…å­˜æ˜¯ç›¸åŒçš„ï¼Œå› æ­¤äº’ç›¸ä¹‹é—´å¯ä»¥å…±äº«

![image-20250627162553508](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20250627162553508.png)

å®ç°ï¼šOPENMP

### Virtual Memory

å†…å­˜åˆ†é¡µï¼š4KB/Page

è™šæ‹Ÿå†…å­˜ï¼šè®©æ¯ä¸€ä¸ªè¿›ç¨‹è®¤ä¸ºè‡ªå·±æœ‰æ— é™å¤§çš„åœ°å€ç©ºé—´ï¼ˆè™šæ‹Ÿåœ°å€ï¼‰ï¼Œæ“ä½œç³»ç»Ÿéœ€è¦å°†è™šæ‹Ÿåœ°å€æ˜ å°„æˆç‰©ç†åœ°å€

è¿›ç¨‹è¦è®¿é—®çš„åœ°å€å°±æ˜¯è™šæ‹Ÿåœ°å€ï¼Œè™šæ‹Ÿåœ°å€->OS->ç‰©ç†åœ°å€

**é¡µè¡¨**ï¼šOSé€šè¿‡ç»™æ¯ä¸ªè¿›ç¨‹ç»´æŠ¤ä¸åŒçš„é¡µè¡¨å®ç°è™šæ‹Ÿåœ°å€åˆ°ç‰©ç†åœ°å€çš„è½¬æ¢

**TLBï¼š**ç¼“å­˜è¿‘æœŸä½¿ç”¨è¿‡çš„è™šæ‹Ÿåœ°å€ä¸ç‰©ç†åœ°å€çš„æ˜ å°„å…³ç³»ï¼Œé¿å…æ¯æ¬¡è®¿å­˜éƒ½æŸ¥çœ‹é¡µè¡¨ï¼ŒåŠ å¿«é€Ÿåº¦

:cat:è™šæ‹Ÿå†…å­˜æ˜¯ä»‹äºè¿›ç¨‹å’Œç‰©ç†å†…å­˜çš„å¦ä¸€ä¸ªæŠ½è±¡å±‚ï¼Œå¯ä»¥ä¿è¯ï¼š

â€¢ **Isolation**: Each process has its own address space.

â€¢ **Protection**: Deny the process from accessing other processesâ€™ or

privileged memory.

â€¢ **Efficiency**: Support Copy-on-Write, can run a partially loaded program.

ç¨‹åºé¦–å…ˆè®¿é—®è™šæ‹Ÿå†…å­˜ï¼Œåœ¨å¯¹åº”æ˜ å°„åˆ°ç‰©ç†å†…å­˜ï¼Œå¯ä»¥ç®€åŒ–ç¨‹åºè®¿é—®ä¸»å­˜çš„å¤æ‚æ€§ï¼Œå¯ä»¥åªåŠ è½½ä¸€éƒ¨åˆ†å†…å­˜åˆ°ç¨‹åºä¸­

**Pageï¼š**è™šæ‹Ÿå†…å­˜ä¸­çš„æœ€å°å†…å­˜å•å…ƒ(4kb)

**Frameï¼š**ç‰©ç†å†…å­˜ä¸­çš„æœ€å°å†…å­˜å•å…ƒ(4kb)

**Memory Mappingï¼š**

- æ•°æ®ç»“æ„ï¼š**Page Table**
- ç¡¬ä»¶æ”¯æŒï¼š**MMU**(Memory Management Unit)
- åŠŸèƒ½ï¼šTranslate **virtual page** to **physical frame**

**Page Fault:** è™šæ‹Ÿå†…å­˜æ²¡æœ‰æ˜ å°„åˆ°ç‰©ç†å†…å­˜ä¸Šæ—¶ï¼ˆç‰©ç†å†…å­˜å·²æ»¡ï¼‰ä¼šå‡ºç°page faultï¼Œæ“ä½œç³»ç»Ÿæš‚æ—¶ä¼šå°†å…¶æ˜ å°„åˆ°ç£ç›˜ä¸­ï¼Œç„¶åéœ€è¦æ—¶å†æŠŠpageä»ç£ç›˜ä¸­åŠ è½½åˆ°ç‰©ç†ä¸­ï¼Œç„¶åæ›´æ–°page tableï¼Œè¿™æ ·å°±å»ºç«‹äº†æ˜ å°„å…³ç³»

**TLB**ï¼šæ“ä½œç³»ç»Ÿä¼šå°†ç»å¸¸ç”¨åˆ°çš„æ˜ å°„å…³ç³»

## Chapter 2 è®¡ç®—æœºä½“ç³»ç»“æ„

### HPCä¸­çš„è½¯ä»¶æ ˆ

- Application
- High-level I/O Library
- I/O Middleware
- I/O Forwarding
- Parallel File System
- I/O Hardware

### X86-64 Registers

- Integer registers:16ä¸ªé€šç”¨å¯„å­˜å™¨ï¼Œæ¯ä¸ª64bits
- SIMD registers

<img src="C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20250628151653832.png" alt="image-20250628151653832" style="zoom: 25%;" />

### åœ¨Cç¨‹åºä¸­åµŒå…¥æ±‡ç¼–è¯­è¨€

- Extended ASMï¼š

  e.g. This code copies src to dst and add 1 to dst

~~~ C
int src = 1, dst;
asm ("mov %1, %0\n\tadd $1, %0" : "=r" (dst) : "r" (src));
printf("%d\n", dst);
~~~

- Compiler Instrisics

~~~ C
_mm_add_ps(), _mm_crc32_u16(), _mm_prefetch()
~~~

### å¾®æ¶æ„

å¾®æ¶æ„æ˜¯å¯¹ISAçš„å…·ä½“å®ç°

### å¤šæ ¸å¤„ç†å™¨

CPUæ€§èƒ½å’ŒCPUé¢‘ç‡ç›´æ¥ç›¸å…³ï¼ŒæœåŠ¡å™¨ä¸Šçš„CPUæ¯”æ™®é€šå®¶ç”¨CPUé¢‘ç‡è¦ä½

æ“ä½œç³»ç»Ÿå°†çº¿ç¨‹å‘é€åˆ°CPUçš„ç¡¬ä»¶ï¼ŒCPUæ ¸å¿ƒæ‰§è¡ŒæŒ‡ä»¤ï¼Œåˆ†æˆå››ä¸ªé˜¶æ®µï¼šFetch,Decode,Execute,Commit

æ­£å¸¸æ‰§è¡Œï¼š<img src="C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20250628152934488.png" alt="image-20250628152934488" style="zoom:50%;" />

:warning: ç¡¬ä»¶ä¸å¯é¿å…çš„ä¼šæµªè´¹ï¼Œè€Œä¸”CPI=0.25ï¼ˆé€Ÿåº¦å¤ªæ…¢ï¼‰

Solutionï¼šæµæ°´çº¿ï¼ˆPipelineï¼‰

<img src="C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20250628153145131.png" alt="image-20250628153145131" style="zoom:50%;" />

**æµæ°´çº¿çš„é—®é¢˜**ï¼š

- æ•°æ®å†²çªï¼šæŒ‡ä»¤å‰åæœ‰æ•°æ®ä¾èµ–
- æ§åˆ¶å†²çªï¼šéœ€è¦è·³è½¬ï¼Œä½†è·³è½¬åœ°å€æœªçŸ¥
- ç»“æ„å†²çªï¼šç¡¬ä»¶èµ„æºè¢«å…¶ä»–æŒ‡ä»¤å ç”¨ï¼Œåªèƒ½ç­‰å¾…

### RAM(Random Access Memory)

åˆ†ç±»ï¼šSRAM(å¿«)ï¼ŒDRAM(éœ€è¦åˆ·æ–°)

### Cache

- SRAM-based

- å’Œå†…å­˜çš„äº¤äº’æ—¶çš„æ•°æ®å¤§å°ï¼šcacheline

- å†…å­˜ä¸ç¼“å­˜çš„æ˜ å°„æ–¹å¼ï¼šéšæœºæ˜ å°„/ç›´æ¥æ˜ å°„/å¤šè·¯ç»„ç›¸è”

- Cache Usageï¼š

  <img src="C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20250628160514039.png" alt="image-20250628160514039" style="zoom: 33%;" />

- åˆ©ç”¨Localityæœ€å¤§åŒ–åˆ©ç”¨Cacheå®ç°ä¼˜åŒ–
- å¤šæ ¸çš„Cacheå±‚æ¬¡æ¶æ„ï¼š

<img src="C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20250628160802245.png" alt="image-20250628160802245" style="zoom:33%;" />



### æµæ°´çº¿çš„å†²çªè§£å†³

- åˆ†æ”¯é¢„æµ‹å’Œæ¨æµ‹æ‰§è¡Œï¼Œå°½é‡å‡å°‘åˆ†æ”¯åˆ¤æ–­

- ä¹±åºæ‰§è¡Œï¼šæé«˜ç¡¬ä»¶åˆ©ç”¨ç‡ï¼Œä¸ºé¿å…æœ‰å‡çš„æ•°æ®ä¾èµ–ï¼ˆå¦‚ä¸‹ï¼‰ï¼Œéœ€è¦è¿›è¡Œå¯„å­˜å™¨çš„é‡å‘½å

  ~~~ C
  //å­—æ¯å‡ä»£è¡¨å¯„å­˜å™¨
  c =  a + b
  c =  d + f
  ~~~

- å¤æ‚æŒ‡ä»¤é›†è½¬åŒ–æˆå¾®ç 

### CPUçš„å‰ç«¯å’Œåç«¯

å‰ç«¯åŠŸèƒ½ï¼šå–å€å’Œè¯‘ç 

åç«¯åŠŸèƒ½ï¼šåˆ†é…ï¼ŒåŠ¨æ€è°ƒåº¦ï¼Œæ‰§è¡Œï¼Œé¡ºåºå®Œæˆï¼ˆæŒ‡ä»¤é‡æ’åºï¼‰

<img src="C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20250628162947303.png" alt="image-20250628162947303" style="zoom: 33%;" />

<img src="C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20250628163410137.png" alt="image-20250628163410137" style="zoom:33%;" />

### è¶…çº¿ç¨‹

**åŒæ­¥å¤šçº¿ç¨‹ï¼š**å¤šå‡ºæ¥çš„çº¿ç¨‹éƒ½æ˜¯è¶…çº¿ç¨‹ 

e.g. 8æ ¸å¿ƒ16çº¿ç¨‹ 

### SIMD(Single Instruction Multiple Data)

æ‹“å®½å¯„å­˜å™¨ï¼Œè¿™æ ·ä¸€æ¡æŒ‡ä»¤å°±å¯ä»¥å°†å¤šä¸ªç»“æœä¸€èµ·ç®—å‡ºæ¥

<img src="C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20250628163953183.png" alt="image-20250628163953183" style="zoom:33%;" />

ä¼˜ç‚¹ï¼šæ€§èƒ½æå‡

é€šè¿‡maskè¿›è¡ŒSIMDï¼Œå¯ä»¥å®ç°åªè®¡ç®—å…¶ä¸­å‡ ä½

SIMDæ”¯æŒä¸è¿ç»­çš„è®¿å­˜

### Multicore and Multi-socket Memory

cacheä¸€è‡´æ€§ï¼šä¿®æ”¹cacheï¼Œéœ€è¦é€šçŸ¥å…¶ä»–coreï¼Œå…¶ä»–coreéœ€è¦æ›´æ–°cacheï¼Œè€Œä¸”é€šä¿¡çš„å¼€é”€ä¹Ÿæ¯”è¾ƒå¤§

NUMAæ¶æ„ï¼šéç»Ÿä¸€å†…å­˜è®¿é—®

<img src="C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20250628165351122.png" alt="image-20250628165351122" style="zoom: 50%;" />
